<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapping Joyscapes</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #map {
            height: 100vh;
            width: 100vw;
            z-index: 10;
            background-color: #f3f4f6;
        }
        .leaflet-tile-pane {
            filter: grayscale(20%) contrast(85%) brightness(110%) hue-rotate(175deg) saturate(130%);
        }
        .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .joy-marker-icon svg { filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3)); }
        .tab-active { background-color: #374151; color: white; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="map"></div>
    <div id="welcome-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-40 flex items-center justify-center p-8 text-center transition-opacity duration-500">
        <div class="max-w-2xl">
            <h1 class="text-4xl md:text-5xl font-bold text-white">Welcome to Mapping Joyscapes</h1>
            <p class="mt-4 text-lg text-gray-200">A space to digitally archive places of safety and joy.</p>
            <p class="mt-4 text-lg text-gray-200">Click the map to add your own story.</p>
            <button id="begin-btn" class="mt-8 px-8 py-3 bg-gray-800 text-white font-semibold rounded-lg hover:bg-black transition-colors shadow-lg hover:shadow-xl">Begin</button>
        </div>
    </div>
    <button id="menu-btn" class="absolute top-20 left-2.5 z-20 bg-white/90 p-2 rounded-md shadow-lg backdrop-blur-sm border-2 border-gray-300 hover:bg-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
    <div id="info-panel" class="hidden fixed inset-0 bg-white/95 z-30 p-4 sm:p-8 md:p-12 overflow-y-auto backdrop-blur-sm">
        <button id="close-panel-btn" class="absolute top-4 right-4 p-3 z-50">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <div class="max-w-3xl mx-auto mt-8">
            <nav class="flex border-b border-gray-300">
                <button data-tab="about" class="tab-button py-3 px-6 font-semibold text-gray-600 hover:bg-gray-200 transition tab-active">About</button>
                <button data-tab="moderation" class="tab-button py-3 px-6 font-semibold text-gray-600 hover:bg-gray-200 transition">Moderation</button>
                <button data-tab="contribute" class="tab-button py-3 px-6 font-semibold text-gray-600 hover:bg-gray-200 transition">Contribute</button>
            </nav>
            <div class="mt-6" id="info-panel-content">
                 <div id="about-content" class="tab-content"><h2 class="text-3xl font-bold text-gray-800">About Joyscapes</h2><p class="mt-4 text-lg text-gray-700">Mapping Joyscapes is a community-generated counter-mapping platform...</p></div>
                <div id="moderation-content" class="tab-content hidden"><h2 class="text-3xl font-bold text-gray-800">Moderation Policy</h2><p class="mt-4 text-lg text-gray-700">To ensure this remains a safe and positive space, all submissions are reviewed...</p></div>
                <div id="contribute-content" class="tab-content hidden"><h2 class="text-3xl font-bold text-gray-800">How to Contribute</h2><p class="mt-4 text-lg text-gray-700">The simplest way to contribute is to add your own story to the map...</p></div>
            </div>
             <div id="user-info" class="mt-12 text-sm text-gray-400 border-t pt-4">Connecting...</div>
        </div>
    </div>
    <div id="story-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform transition-all duration-300 ease-out scale-95 opacity-0" id="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Share Your Joyscape</h2>
            <p class="text-gray-600 mb-6">Describe the moment of joy or safety you experienced in this place.</p>
            <textarea id="story-input" class="w-full h-40 p-3 border rounded-lg focus:ring-2 focus:ring-red-400" placeholder="Write your story here..."></textarea>
            <div id="submission-feedback" class="hidden mt-4 text-center text-green-600 font-semibold">Thank you! Your story has been submitted for review.</div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="close-modal-btn" class="px-6 py-2 bg-gray-100 rounded-lg">Cancel</button>
                <button id="submit-story-btn" class="px-6 py-2 bg-red-500 text-white font-semibold rounded-lg">Submit</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, GeoPoint } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION & INITIALIZATION ---
        // PASTE YOUR REAL FIREBASE CONFIG OBJECT HERE
        const firebaseConfig = {
          apiKey: "AIzaSyAH-nCy7ipiKwp9LuL5HQbM8fZjphE3ips",
          authDomain: "joyscapes-2fefe.firebaseapp.com",
          projectId: "joyscapes-2fefe",
          storageBucket: "joyscapes-2fefe.firebasestorage.app",
          messagingSenderId: "809704822390",
          appId: "1:809704822390:web:6ed3def3fd9934123db157"
        };
        
        let db, auth;
        let currentUserId = null;
        let tempCoords = null; 
        const appId = "joyscapes-app"; // A simple identifier for our app

        // DOM Element references
        const welcomeModal = document.getElementById('welcome-modal');
        const beginBtn = document.getElementById('begin-btn');
        const menuBtn = document.getElementById('menu-btn');
        const infoPanel = document.getElementById('info-panel');
        const closePanelBtn = document.getElementById('close-panel-btn');
        const storyModal = document.getElementById('story-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const submitStoryBtn = document.getElementById('submit-story-btn');
        const storyInput = document.getElementById('story-input');
        const submissionFeedback = document.getElementById('submission-feedback');
        const userInfoDiv = document.getElementById('user-info');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // MAP SETUP
        const map = L.map('map', { minZoom: 2 }).setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 20,
        }).addTo(map);

        const joyIcon = L.divIcon({
            html: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#c53030" stroke="white" stroke-width="1"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`,
            className: 'joy-marker-icon'
        });

        // UI FUNCTIONS
        function openStoryModal() {
            submissionFeedback.classList.add('hidden');
            storyModal.classList.remove('hidden');
            setTimeout(() => { modalContent.classList.remove('scale-95', 'opacity-0'); }, 10);
        }

        function closeStoryModal() {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                storyModal.classList.add('hidden');
                storyInput.value = '';
            }, 300);
        }

        function closeWelcomeModal() {
            welcomeModal.classList.add('opacity-0');
            setTimeout(() => { welcomeModal.classList.add('hidden'); }, 500);
        }
        
        function openInfoPanel() { infoPanel.classList.remove('hidden'); }
        function closeInfoPanel() { infoPanel.classList.add('hidden'); }
        
        function switchTab(e) {
            const targetTab = e.currentTarget.dataset.tab;
            tabButtons.forEach(button => button.classList.remove('tab-active'));
            e.currentTarget.classList.add('tab-active');
            tabContents.forEach(content => {
                content.id === `${targetTab}-content` ? content.classList.remove('hidden') : content.classList.add('hidden');
            });
        }

        // FIREBASE & DATA LOGIC
        async function initializeFirebase() {
            try {
                if (firebaseConfig.apiKey.includes("...")) {
                     console.error("Firebase config has not been replaced with your real keys.");
                     return;
                }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, user => {
                    if (user) {
                        currentUserId = user.uid;
                        userInfoDiv.textContent = `Connected as: ${user.isAnonymous ? 'Anonymous' : user.email}`;
                    } else {
                       signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
                    }
                });
                listenForJoyscapes();
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }
        
        function listenForJoyscapes() {
             const joyscapesCollection = collection(db, `artifacts/${appId}/public/data/joyscapes`);
             onSnapshot(joyscapesCollection, (snapshot) => {
                 snapshot.docChanges().forEach((change) => {
                     if (change.type === "added") {
                         const joyscape = change.doc.data();
                         if (joyscape.location && joyscape.story) {
                             L.marker([joyscape.location.latitude, joyscape.location.longitude], { icon: joyIcon }).addTo(map)
                                 .bindPopup(`<strong>A moment of joy:</strong><br>${joyscape.story}`);
                         }
                     }
                 });
             }, (error) => console.error("Error fetching joyscapes: ", error));
        }
        
        async function submitJoyscape() {
            if (!db || !currentUserId || !tempCoords) return;
            const storyText = storyInput.value.trim();
            if (storyText === "") return alert("Please write something for your joyscape!");
            
            submitStoryBtn.disabled = true;
            submitStoryBtn.textContent = 'Submitting...';

            try {
                const submissionsCollection = collection(db, `artifacts/${appId}/public/data/submissions`);
                await addDoc(submissionsCollection, {
                    story: storyText,
                    location: new GeoPoint(tempCoords.lat, tempCoords.lng),
                    authorId: currentUserId,
                    createdAt: new Date(),
                    status: 'pending'
                });
                
                submissionFeedback.classList.remove('hidden');
                setTimeout(() => {
                    closeStoryModal();
                    submitStoryBtn.disabled = false;
                    submitStoryBtn.textContent = 'Submit';
                }, 2000);

            } catch (error) {
                console.error("Error adding document: ", error);
                alert("There was an error saving your story. Please try again.");
                submitStoryBtn.disabled = false;
                submitStoryBtn.textContent = 'Submit';
            }
        }

        // EVENT LISTENERS
        map.on('click', (e) => {
            tempCoords = e.latlng.wrap(); 
            openStoryModal();
        });

        closeModalBtn.addEventListener('click', closeStoryModal);
        submitStoryBtn.addEventListener('click', submitJoyscape);
        beginBtn.addEventListener('click', closeWelcomeModal);
        menuBtn.addEventListener('click', openInfoPanel);
        closePanelBtn.addEventListener('click', closeInfoPanel);
        tabButtons.forEach(button => button.addEventListener('click', switchTab));
        
        // START THE APP
        window.onload = initializeFirebase;
    </script>
</body>
</html>
