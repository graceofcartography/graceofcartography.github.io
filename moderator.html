<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joyscapes - Moderator Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-white shadow-md">
        <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Moderator Panel</h1>
            <div id="auth-container">
                <button id="login-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600">Login with Google</button>
                <div id="user-info" class="hidden items-center">
                    <p id="user-email" class="text-sm text-gray-600 mr-4"></p>
                    <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <main id="content-area" class="max-w-4xl mx-auto p-4 mt-8">
        <div id="login-prompt" class="text-center bg-white p-12 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700">Please log in to view submissions.</h2>
        </div>

        <div id="submissions-container" class="hidden">
            <h2 class="text-2xl font-bold border-b pb-2 mb-4">Pending Submissions</h2>
            <div id="submissions-list" class="space-y-4"></div>
            <p id="no-submissions" class="hidden text-center text-gray-500 mt-8">No pending submissions.</p>

            <!-- NEW: Section for managing approved entries -->
            <div class="mt-12">
                <h2 class="text-2xl font-bold border-b pb-2 mb-4">Manage Approved Joyscapes</h2>
                <div id="approved-list" class="space-y-4"></div>
                <p id="no-approved" class="hidden text-center text-gray-500 mt-8">No approved joyscapes found.</p>
            </div>
        </div>
    </main>

    <!-- NEW: Confirmation Modal for Deletion -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-900">Are you sure?</h3>
            <p class="mt-2 text-gray-600">This action is permanent and cannot be undone. The joyscape will be removed from the public map forever.</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Yes, Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        // PASTE YOUR REAL FIREBASE CONFIG OBJECT HERE
        const firebaseConfig = {
          apiKey: "AIzaSyAH-nCy7ipiKwp9LuL5HQbM8fZjphE3ips",
          authDomain: "joyscapes-2fefe.firebaseapp.com",
          projectId: "joyscapes-2fefe",
          storageBucket: "joyscapes-2fefe.firebasestorage.app",
          messagingSenderId: "809704822390",
          appId: "1:809704822390:web:6ed3def3fd9934123db157"
        };
        const appId = "joyscapes-app"; 

        let db, auth;
        let docIdToDelete = null; // Variable to store the ID of the doc to delete

        // --- 2. DOM ELEMENTS ---
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');
        const loginPrompt = document.getElementById('login-prompt');
        const submissionsContainer = document.getElementById('submissions-container');
        const submissionsList = document.getElementById('submissions-list');
        const noSubmissionsMsg = document.getElementById('no-submissions');
        const approvedList = document.getElementById('approved-list');
        const noApprovedMsg = document.getElementById('no-approved');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const contentArea = document.getElementById('content-area'); // Main content area for delegation

        // --- 3. AUTHENTICATION ---
        async function setupAuth() {
            try {
                if (firebaseConfig.apiKey.includes("...")) {
                    alert("Firebase config is not set. Please replace the placeholder keys in your moderator.html file.");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, user => {
                    if (user) {
                        loginBtn.classList.add('hidden');
                        userInfo.classList.remove('hidden');
                        userEmail.textContent = user.email;
                        loginPrompt.classList.add('hidden');
                        submissionsContainer.classList.remove('hidden');
                        fetchSubmissions();
                        fetchApprovedJoyscapes(); // Fetch approved joyscapes on login
                    } else {
                        loginBtn.classList.remove('hidden');
                        userInfo.classList.add('hidden');
                        loginPrompt.classList.remove('hidden');
                        submissionsContainer.classList.add('hidden');
                        submissionsList.innerHTML = '';
                        approvedList.innerHTML = ''; // Clear approved list on logout
                    }
                });

                loginBtn.addEventListener('click', () => {
                    const provider = new GoogleAuthProvider();
                    signInWithPopup(auth, provider).catch(error => console.error("Login failed:", error));
                });

                logoutBtn.addEventListener('click', () => signOut(auth));
            } catch (error) {
                console.error("Firebase Init Error:", error);
                alert("Failed to initialize Firebase. Check console.");
            }
        }
        
        // --- 4. DATA FETCHING AND RENDERING ---
        async function fetchSubmissions() {
            if (!auth.currentUser) return;
            submissionsList.innerHTML = '<div>Loading submissions...</div>';
            noSubmissionsMsg.classList.add('hidden');
            try {
                const submissionsCollection = collection(db, `artifacts/${appId}/public/data/submissions`);
                const q = query(submissionsCollection, where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                submissionsList.innerHTML = ''; 
                if (querySnapshot.empty) {
                    noSubmissionsMsg.classList.remove('hidden');
                } else {
                    querySnapshot.forEach(doc => renderSubmission(doc.id, doc.data()));
                }
            } catch (error) {
                console.error("Error fetching submissions: ", error);
                submissionsList.innerHTML = `<div class="text-red-600 p-4 bg-red-100 rounded-lg">Error: ${error.message}. You might not have moderator permissions.</div>`;
            }
        }

        async function fetchApprovedJoyscapes() {
            if (!auth.currentUser) return;
            approvedList.innerHTML = '<div>Loading approved entries...</div>';
            noApprovedMsg.classList.add('hidden');
            try {
                const joyscapesCollection = collection(db, `artifacts/${appId}/public/data/joyscapes`);
                const querySnapshot = await getDocs(joyscapesCollection);
                approvedList.innerHTML = ''; 
                if (querySnapshot.empty) {
                    noApprovedMsg.classList.remove('hidden');
                } else {
                    querySnapshot.forEach(doc => renderApprovedJoyscape(doc.id, doc.data()));
                }
            } catch (error) {
                console.error("Error fetching approved joyscapes: ", error);
                approvedList.innerHTML = `<div class="text-red-600 p-4 bg-red-100 rounded-lg">Error: ${error.message}. You might not have moderator permissions.</div>`;
            }
        }

        function renderSubmission(id, data) {
            const div = document.createElement('div');
            div.className = 'bg-white p-6 rounded-lg shadow flex justify-between items-center gap-4';
            div.innerHTML = `
                <div class="prose max-w-none flex-grow"><p>${data.story}</p><small class="text-gray-400">Lat: ${data.location.latitude.toFixed(4)}, Lng: ${data.location.longitude.toFixed(4)}</small></div>
                <div class="flex-shrink-0 flex space-x-2"><button data-id="${id}" class="approve-btn px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600">Approve</button><button data-id="${id}" class="reject-btn px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">Reject</button></div>
            `;
            submissionsList.appendChild(div);
        }
        
        function renderApprovedJoyscape(id, data) {
            const div = document.createElement('div');
            div.className = 'bg-white p-6 rounded-lg shadow flex justify-between items-center gap-4';
            div.innerHTML = `
                <div class="prose max-w-none flex-grow"><p>${data.story}</p><small class="text-gray-400">Lat: ${data.location.latitude.toFixed(4)}, Lng: ${data.location.longitude.toFixed(4)}</small></div>
                <div class="flex-shrink-0 flex space-x-2"><button data-id="${id}" class="delete-btn px-4 py-2 bg-gray-700 text-white font-semibold rounded-lg hover:bg-black">Delete</button></div>
            `;
            approvedList.appendChild(div);
        }

        // --- 5. MODERATION ACTIONS ---
        async function approveSubmission(id) {
            const submissionRef = doc(db, `artifacts/${appId}/public/data/submissions`, id);
            const joyscapesRef = doc(db, `artifacts/${appId}/public/data/joyscapes`, id); 
            try {
                const subDoc = await getDoc(submissionRef);
                if (subDoc.exists()) {
                    const dataToApprove = subDoc.data();
                    delete dataToApprove.status; 
                    await setDoc(joyscapesRef, dataToApprove);
                    await deleteDoc(submissionRef); 
                    fetchSubmissions(); 
                    fetchApprovedJoyscapes();
                }
            } catch (error) {
                console.error("Error approving submission: ", error);
            }
        }

        async function rejectSubmission(id) {
            const submissionRef = doc(db, `artifacts/${appId}/public/data/submissions`, id);
            try {
                await deleteDoc(submissionRef);
                fetchSubmissions();
            } catch (error) {
                console.error("Error rejecting submission: ", error);
            }
        }
        
        function promptForDelete(id) {
            docIdToDelete = id;
            deleteConfirmModal.classList.remove('hidden');
        }
        
        async function performDelete() {
            if (!docIdToDelete) return;
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = 'Deleting...';
            const joyscapeRef = doc(db, `artifacts/${appId}/public/data/joyscapes`, docIdToDelete);
            try {
                await deleteDoc(joyscapeRef);
                await fetchApprovedJoyscapes();
            } catch(error) {
                console.error("Error deleting joyscape: ", error);
                alert("Failed to delete joyscape.");
            } finally {
                closeDeleteModal();
            }
        }
        
        function closeDeleteModal() {
            docIdToDelete = null;
            deleteConfirmModal.classList.add('hidden');
            confirmDeleteBtn.disabled = false;
            confirmDeleteBtn.textContent = 'Yes, Delete';
        }

        // --- 6. EVENT LISTENERS ---
        contentArea.addEventListener('click', (e) => {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;

            if (target.classList.contains('approve-btn') || target.classList.contains('reject-btn')) {
                target.disabled = true;
                target.textContent = '...';
                target.classList.contains('approve-btn') ? approveSubmission(id) : rejectSubmission(id);
            } else if (target.classList.contains('delete-btn')) {
                promptForDelete(id);
            }
        });

        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        confirmDeleteBtn.addEventListener('click', performDelete);

        // --- 7. INITIALIZE ---
        setupAuth();

    </script>
</body>
</html>
